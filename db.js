// Supabase Database Service Layer
// PROD: Keys are loaded from config.js (generated by Netlify)
// DEV: Keys are loaded from local config.js
let SUPABASE_URL = '';
let SUPABASE_ANON_KEY = '';

if (typeof CONFIG !== 'undefined') {
    if (CONFIG.SUPABASE_URL) SUPABASE_URL = CONFIG.SUPABASE_URL;
    if (CONFIG.SUPABASE_ANON_KEY) SUPABASE_ANON_KEY = CONFIG.SUPABASE_ANON_KEY;
} else {
    console.error("Critical: config.js not found. Environment variables missing.");
}

window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Database Service
const db = {
    // Daily Entries
    async saveDailyEntry(date, data) {
        const { error } = await window.sb
            .from('daily_entries')
            .upsert({
                user_id: window.currentUserId,
                entry_date: date,
                ...data,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id,entry_date'
            });
        if (error) console.error('Error saving daily entry:', error);
    },

    async getDailyEntry(date) {
        const { data, error } = await window.sb
            .from('daily_entries')
            .select('*')
            .eq('entry_date', date)
            .single();
        if (error && error.code !== 'PGRST116') console.error('Error loading daily entry:', error);
        return data || {};
    },

    // Habits
    async saveHabitsList(habits) {
        // Clear existing and insert new
        await window.sb.from('habits_master').delete().eq('user_id', window.currentUserId);
        const habitsData = habits.map((habit, index) => ({
            user_id: window.currentUserId,
            habit_name: habit,
            sort_order: index
        }));
        const { error } = await window.sb.from('habits_master').insert(habitsData);
        if (error) console.error('Error saving habits:', error);
    },

    async getHabitsList() {
        const { data, error } = await window.sb
            .from('habits_master')
            .select('*')
            .order('sort_order');
        if (error) console.error('Error loading habits:', error);
        return data ? data.map(h => h.habit_name) : [];
    },

    async saveWeeklyHabit(weekNumber, habitIndex, dayIndex, completed, goal = null) {
        const { error } = await window.sb
            .from('weekly_habits')
            .upsert({
                user_id: window.currentUserId,
                week_number: weekNumber,
                habit_index: habitIndex,
                day_index: dayIndex,
                completed: completed,
                goal: goal
            }, {
                onConflict: 'user_id,week_number,habit_index,day_index'
            });
        if (error) console.error('Error saving weekly habit:', error);
    },

    async getWeeklyHabits(weekNumber) {
        const { data, error } = await window.sb
            .from('weekly_habits')
            .select('*')
            .eq('week_number', weekNumber);
        if (error) console.error('Error loading weekly habits:', error);
        return data || [];
    },

    // Roadmap
    async saveRoadmap(roadmapData) {
        const { data: existing } = await window.sb
            .from('roadmap_goals')
            .select('id')
            .eq('user_id', window.currentUserId)
            .limit(1)
            .single();

        if (existing) {
            const { error } = await window.sb
                .from('roadmap_goals')
                .update({ ...roadmapData, updated_at: new Date().toISOString() })
                .eq('id', existing.id);
            if (error) console.error('Error updating roadmap:', error);
        } else {
            const { error } = await window.sb
                .from('roadmap_goals')
                .insert({ user_id: window.currentUserId, ...roadmapData });
            if (error) console.error('Error creating roadmap:', error);
        }
    },

    async getRoadmap() {
        const { data, error } = await window.sb
            .from('roadmap_goals')
            .select('*')
            .limit(1)
            .single();
        if (error && error.code !== 'PGRST116') console.error('Error loading roadmap:', error);
        return data || {};
    },

    // Life Vision
    async saveLifeVision(goalIndex, goalText) {
        const { error } = await window.sb
            .from('life_vision')
            .upsert({
                user_id: window.currentUserId,
                goal_index: goalIndex,
                goal_text: goalText,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id,goal_index'
            });
        if (error) console.error('Error saving life vision:', error);
    },

    async getLifeVision() {
        const { data, error } = await window.sb
            .from('life_vision')
            .select('*')
            .order('goal_index');
        if (error) console.error('Error loading life vision:', error);
        return data || [];
    },

    // Monthly Data
    async saveMonthlyData(year, month, data) {
        const { error } = await window.sb
            .from('monthly_data')
            .upsert({
                user_id: window.currentUserId,
                year: year,
                month: month,
                ...data,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id,year,month'
            });
        if (error) console.error('Error saving monthly data:', error);
    },

    async getMonthlyData(year, month) {
        const { data, error } = await window.sb
            .from('monthly_data')
            .select('*')
            .eq('year', year)
            .eq('month', month)
            .single();
        if (error && error.code !== 'PGRST116') console.error('Error loading monthly data:', error);
        return data || {};
    },

    // Weekly Strategy
    async saveWeeklyStrategy(strategyData) {
        const { data: existing } = await window.sb
            .from('weekly_strategy')
            .select('id')
            .eq('user_id', window.currentUserId)
            .limit(1)
            .single();

        if (existing) {
            const { error } = await window.sb
                .from('weekly_strategy')
                .update({ ...strategyData, updated_at: new Date().toISOString() })
                .eq('id', existing.id);
            if (error) console.error('Error updating strategy:', error);
        } else {
            const { error } = await window.sb
                .from('weekly_strategy')
                .insert({ user_id: window.currentUserId, ...strategyData });
            if (error) console.error('Error creating strategy:', error);
        }
    },

    async getWeeklyStrategy() {
        const { data, error } = await window.sb
            .from('weekly_strategy')
            .select('*')
            .limit(1)
            .single();
        if (error && error.code !== 'PGRST116') console.error('Error loading strategy:', error);
        return data || {};
    }
};
window.db = db;
